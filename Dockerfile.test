FROM roquie/composer-parallel

COPY . /app
RUN composer install --no-ansi --no-interaction --no-progress --no-scripts --optimize-autoloader --ignore-platform-reqs

FROM roquie/docker-swoole-webapp:7.3-latest

COPY --from=0 /app /app

RUN apk --no-cache update \
    && apk --no-cache add bash php7-xdebug --repository http://dl-3.alpinelinux.org/alpine/edge/testing/ \
    && echo "zend_extension=/usr/lib/php7/modules/xdebug.so\nxdebug.coverage_enable=1" > /etc/php7/php.ini

EXPOSE 8080
WORKDIR /app

ENTRYPOINT ["bash", "-c", "vendor/bin/phpunit --coverage-clover=coverage.xml && bash <(curl -s https://codecov.io/bash)"]
